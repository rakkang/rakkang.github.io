<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Ruikye"><meta name="description" content="由于一直在Mac上做Android开发，习惯在命令行下使用adb命令调试。在开发调试中经常碰到一些问题：多设备连接时，adb使用很麻烦，每次都要查询设备id然后复制粘贴adblogcat输出的Tag的不同级别不能按颜色区分adblogcat按包名"><meta name="keywords" content="Python,Android"><title>ADB 的 Python 扩展 · Ruikye</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://ruikye.com/2015/03/14/adb-logcat-with-color/"><link rel="alternate" href="/atom.xml" title="Ruikye"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">Ruikye</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Catalog</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">ADB 的 Python 扩展</h1><span class="post-time">2015年3月14日</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#多设备选择"><span class="toc-text">多设备选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#adb-logcat-带颜色输出"><span class="toc-text">adb logcat 带颜色输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ADB-截屏"><span class="toc-text">ADB 截屏</span></a></li></ol></div><div class="post-content"><p>由于一直在 Mac 上做 Android 开发，习惯在命令行下使用 adb 命令调试。在开发调试中经常碰到一些问题：</p>
<ul>
<li>多设备连接时，adb 使用很麻烦，每次都要查询设备id然后复制粘贴</li>
<li>adb logcat 输出的 Tag 的不同级别不能按颜色区分</li>
<li>adb logcat 按包名过滤</li>
<li>adb 截屏并保存到指定路径</li>
</ul>
<p>经常被这些问题搞得很郁闷，所以决定用 Python 扩展下 adb 命令的功能：</p>
<a id="more"></a>
<ul>
<li>多设备连接时，可以选择</li>
<li>adb logcat 不同级别按颜色区分</li>
<li>按包名过滤</li>
<li>adb 截屏并保存到指定路径</li>
</ul>
<h3 id="多设备选择"><a href="#多设备选择" class="headerlink" title="多设备选择"></a>多设备选择</h3><ul>
<li><p>实现方式：</p>
<blockquote>
<p>如果连接了多设备，先查询出所有可用设备并编号，然后列出带编号的设备。选择编号就可以连接<code>adb</code>到指定设备：</p>
</blockquote>
</li>
<li><p>运行截图：</p>
</li>
</ul>
<p><img src="/img/multi_adb.png" alt="multiple_devices_adb"></p>
<ul>
<li><p>实现脚本：</p>
<ul>
<li><p>多设备选择(<em>libadb.py</em>)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_target_devices</span><span class="params">()</span>:</span></div><div class="line">    devices = os.popen(<span class="string">"adb devices -l | sed '1d' | sed '/./!d'"</span>).readlines()</div><div class="line"></div><div class="line">    <span class="comment"># If only one devices, don't select anything</span></div><div class="line">    <span class="keyword">if</span> len(devices) &gt; <span class="number">1</span>:</div><div class="line">        remodel = re.compile(<span class="string">"^(.*)device.*model:(.*)device.*$"</span>)</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">read_a_target</span><span class="params">(max)</span>:</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'Target:'</span>,</div><div class="line"></div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                var = raw_input()</div><div class="line">            <span class="keyword">except</span> KeyboardInterrupt:</div><div class="line">                sys.stdout.flush()</div><div class="line">                exit(<span class="number">1</span>)</div><div class="line"></div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                var = int(var)</div><div class="line">                <span class="keyword">if</span> <span class="number">0</span> &lt;= var &lt;= max:</div><div class="line">                    <span class="keyword">return</span> var</div><div class="line">                <span class="keyword">return</span> read_a_target(max)</div><div class="line">            <span class="keyword">except</span> Exception, e:</div><div class="line">                <span class="keyword">return</span> read_a_target(max)</div><div class="line"></div><div class="line">        <span class="keyword">print</span> <span class="string">'Select the target device: '</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(devices)):</div><div class="line">            res = remodel.match(devices[i])</div><div class="line">            <span class="keyword">if</span> res:</div><div class="line">                id, model = res.groups()</div><div class="line">                <span class="keyword">print</span> <span class="string">'[%d]: %s -&gt; %s'</span> % (i, id.strip().upper(), model.strip())</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                tmparr = re.compile(<span class="string">"\\s+"</span>).split(devices[i])</div><div class="line">                <span class="keyword">print</span> <span class="string">'[%d]: %s -&gt; %s'</span> % (i, tmparr[<span class="number">0</span>].upper(), tmparr[<span class="number">1</span>])</div><div class="line"></div><div class="line">        target = read_a_target(len(devices) - <span class="number">1</span>)</div><div class="line">        res = remodel.match(devices[target])</div><div class="line">        <span class="keyword">if</span> res:</div><div class="line">            id, model = res.groups()</div><div class="line">            <span class="keyword">return</span> id.strip()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            tmparr = re.compile(<span class="string">"\\s+"</span>).split(devices[target])</div><div class="line">            <span class="keyword">print</span> <span class="string">'The target is %s'</span> % tmparr[<span class="number">1</span>]</div><div class="line">            exit(<span class="number">0</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure>
</li>
<li><p>adk 脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> libadb       <span class="comment"># 导入自定义的 libadb.py</span></div><div class="line"></div><div class="line">args = sys.argv[<span class="number">1</span>:]</div><div class="line"></div><div class="line">dev = <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="comment"># If no special device and args not null</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">not</span> <span class="string">'-s'</span> <span class="keyword">in</span> args) <span class="keyword">and</span> len(args) <span class="keyword">and</span> (args[<span class="number">0</span>] != <span class="string">'devices'</span>):</div><div class="line">    dev = libadb.select_target_devices()</div><div class="line"></div><div class="line"><span class="keyword">if</span> dev:</div><div class="line">    dev = <span class="string">'-s %s'</span> % dev</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    dev = <span class="string">''</span></div><div class="line"></div><div class="line">os.system(<span class="string">'adb %s %s'</span> % (dev, <span class="string">' '</span>.join(args)))</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>一般为了方便使用，会更改执行权限并链接到用户的命令目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ chmod a+x adk.py</div><div class="line"></div><div class="line">$ ln <span class="_">-s</span> ~/python/adb/adk.py /usr/<span class="built_in">local</span>/bin/adk</div><div class="line"><span class="comment"># 之后就可以使用 adk 替换 adb 命令的使用了</span></div><div class="line">$ adk logcat   <span class="comment"># 相当于 adb logcat</span></div></pre></td></tr></table></figure>
<h3 id="adb-logcat-带颜色输出"><a href="#adb-logcat-带颜色输出" class="headerlink" title="adb logcat 带颜色输出"></a>adb logcat 带颜色输出</h3><ul>
<li>实现方式：</li>
</ul>
<blockquote>
<p>之前在 <a href="http://stackoverflow.com" target="_blank" rel="external">StackOverflow</a> 上找到了一个实现：<a href="http://stackoverflow.com/questions/11204202/color-of-adb-logcat-in-ubuntu-command-line" target="_blank" rel="external">http://stackoverflow.com/questions/11204202/color-of-adb-logcat-in-ubuntu-command-line</a>, 但是实现的不太好，有几个问题：</p>
</blockquote>
<ul>
<li>如果输出带时间的 log 彩色效果会失效</li>
<li>不能持续的等待 adb logcat 的输出，经常会突然断开</li>
<li><p>多设备连接的问题</p>
<blockquote>
<p>针对以上问题做了改进并去掉了log的格式化效果<br>级别颜色：<br>“V”:··········# 灰色<br>“I”:··········# 绿色<br>“D”:··········# 青色<br>“W”:··········# 黄色<br>“E”:··········# 红色</p>
</blockquote>
</li>
</ul>
<ul>
<li>效果截图：</li>
</ul>
<p><img src="/img/color_adblog.png" alt="color_adblog"></p>
<ul>
<li>按包名过滤的使用：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user@shell ~: adblog -s &lt;Tag1 ...&gt; -app [packages ...]</div></pre></td></tr></table></figure>
<ul>
<li>实现脚本(<em>adblog.py</em>)：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> libadb       <span class="comment"># 导入自定义的 libadb.py</span></div><div class="line"></div><div class="line">raw_args = sys.argv[<span class="number">1</span>:]</div><div class="line"></div><div class="line">dev = libadb.select_target_devices()</div><div class="line"></div><div class="line"><span class="keyword">if</span> dev:</div><div class="line">    dev = <span class="string">'-s %s'</span> % dev</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    dev = <span class="string">''</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_packages</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'-app'</span> <span class="keyword">in</span> raw_args:</div><div class="line">        i = raw_args.index(<span class="string">'-app'</span>)</div><div class="line">        sub_arr = raw_args[i:]</div><div class="line">        out_args = <span class="keyword">None</span></div><div class="line">        <span class="keyword">for</span> arg <span class="keyword">in</span> sub_arr:</div><div class="line">            <span class="keyword">if</span> arg.startswith(<span class="string">'-'</span>):</div><div class="line">                <span class="keyword">if</span> arg == <span class="string">'-app'</span>:</div><div class="line">                    <span class="keyword">continue</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">            <span class="keyword">elif</span> <span class="keyword">not</span> <span class="string">':'</span> <span class="keyword">in</span> arg:</div><div class="line">                <span class="keyword">if</span> <span class="keyword">not</span> out_args:</div><div class="line">                    out_args = []</div><div class="line"></div><div class="line">                out_args.append(arg.replace(<span class="string">'*'</span>, <span class="string">''</span>))</div><div class="line"></div><div class="line">        raw_args.remove(<span class="string">'-app'</span>)</div><div class="line">        <span class="keyword">return</span> out_args</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">peek_special_package</span><span class="params">(package)</span>:</span></div><div class="line">    <span class="keyword">return</span> os.popen(<span class="string">"adb %s shell ps | grep -E '%s' | cut -c10-15 | xargs"</span></div><div class="line">                    % (dev, package)).readline().strip().split(<span class="string">' '</span>)</div><div class="line"></div><div class="line">packages = parse_packages()</div><div class="line"></div><div class="line"><span class="keyword">if</span> packages:</div><div class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> packages:</div><div class="line">        <span class="keyword">if</span> arg <span class="keyword">in</span> raw_args:</div><div class="line">            raw_args.remove(arg)</div><div class="line"></div><div class="line">    packages = peek_special_package(<span class="string">'|'</span>.join(packages))</div><div class="line"></div><div class="line"><span class="comment"># to pick up -d or -e</span></div><div class="line">adb_args = <span class="string">' '</span>.join(raw_args)</div><div class="line"></div><div class="line"><span class="keyword">if</span> adb_args.startswith(<span class="string">'--help'</span>):</div><div class="line">    os.system(<span class="string">'adb logcat --help'</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">'\033[01;32mFilter by package name:\033[0m                                        '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'[option]:                                                                        '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'  -app &lt;pacakges&gt;        fuzzy match the packge name, eg: "google" will match all'</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'                         google apps: com.google, com.android.google and so on.  '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'                                                                                 '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'User for zsh: if use "*" eg: adblog *:W, need add prefix "noglob"; Like bellow:  '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'                                                                                 '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'  $zsh@usr ~: noglob adblog *:W -app com.google com.anroid                       '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'                                                                                 '</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'                                                                                 '</span></div><div class="line">    exit(<span class="number">0</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># if someone is piping in to us, use stdin as input.  if not, invoke adb logcat</span></div><div class="line"><span class="keyword">if</span> os.isatty(sys.stdin.fileno()):</div><div class="line">    <span class="keyword">print</span> <span class="string">"[exec]: adb %s logcat %s"</span> % (dev, adb_args)</div><div class="line">    input = os.popen(<span class="string">"adb %s logcat %s"</span> % (dev, adb_args))</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    input = sys.stdin</div><div class="line"></div><div class="line">COLORS = &#123;</div><div class="line">    <span class="string">"V"</span>: <span class="string">"\033[22;37m"</span>,         <span class="comment"># 灰色</span></div><div class="line">    <span class="string">"I"</span>: <span class="string">"\033[22;32m"</span>,         <span class="comment"># 绿色</span></div><div class="line">    <span class="string">"D"</span>: <span class="string">"\033[22;36m"</span>,         <span class="comment"># 青色</span></div><div class="line">    <span class="string">"W"</span>: <span class="string">"\033[22;33m"</span>,         <span class="comment"># 黄色</span></div><div class="line">    <span class="string">"E"</span>: <span class="string">"\033[22;31m"</span>,         <span class="comment"># 红色</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">retag = re.compile(<span class="string">"(.*)([A-Z])/([^\(]+)\(([^\)]+)\): (.*)$"</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> adb_args.startswith(<span class="string">'-c'</span>):</div><div class="line">    exit(<span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        line = input.readline()</div><div class="line">    <span class="keyword">except</span> KeyboardInterrupt:</div><div class="line">        sys.stdout.flush()</div><div class="line">        <span class="keyword">break</span></div><div class="line"></div><div class="line">    match = retag.match(line)</div><div class="line">    <span class="keyword">if</span> match:</div><div class="line">        pref, tagtype, tag, owner, message = match.groups()</div><div class="line"></div><div class="line">        <span class="comment"># filter by multiple package name</span></div><div class="line">        <span class="keyword">if</span> packages <span class="keyword">and</span> owner <span class="keyword">and</span> <span class="keyword">not</span> owner.strip() <span class="keyword">in</span> packages:</div><div class="line">            <span class="keyword">continue</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> tagtype <span class="keyword">in</span> COLORS:</div><div class="line">            line = <span class="string">"%s%s"</span> % (COLORS[tagtype], line)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> len(line) == <span class="number">0</span>:</div><div class="line">        <span class="keyword">break</span></div><div class="line"></div><div class="line">    sys.stdout.write(line)</div></pre></td></tr></table></figure>
<h3 id="ADB-截屏"><a href="#ADB-截屏" class="headerlink" title="ADB 截屏"></a>ADB 截屏</h3><ul>
<li><p>实现方式：</p>
<blockquote>
<p>利用 <code>adb shell</code> 的 <code>screencap</code> 命令，先截取屏幕并保存到设备的 /sdcard 目录，之后利用 <code>adb pull</code> 上传到电脑的指定目录，同时删除设备 /sdcard 保存的文件</p>
</blockquote>
</li>
<li><p>运行截图：</p>
</li>
</ul>
<p><img src="/img/adbshot.png" alt="adbshot命令"></p>
<ul>
<li>实现脚本(<em>adbshot.py</em>)：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> libadb       <span class="comment"># 导入自定义的 libadb.py</span></div><div class="line"></div><div class="line">args = sys.argv[<span class="number">1</span>:]</div><div class="line"></div><div class="line">dev = libadb.select_target_devices()</div><div class="line"></div><div class="line"><span class="keyword">if</span> dev:</div><div class="line">    dev = <span class="string">'-s %s'</span> % dev</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    dev = <span class="string">''</span></div><div class="line"></div><div class="line">destfile = <span class="keyword">None</span></div><div class="line"><span class="keyword">if</span> len(args):</div><div class="line">    destfile = args[<span class="number">0</span>]</div><div class="line"></div><div class="line">filename = time.strftime(<span class="string">'%Y%m%d%H%M%S'</span>, time.localtime(time.time()))</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> destfile:</div><div class="line">    destfile = <span class="string">"~/Pictures/Screenshot/adbshot/screenshot_%s.png"</span> % filename</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    path, tfile = os.path.split(destfile)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</div><div class="line">        <span class="keyword">print</span> <span class="string">"Create path: "</span>, path</div><div class="line">        os.system(<span class="string">'mkdir -p %s'</span> % path)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">''</span> == tfile:</div><div class="line">        destfile = <span class="string">'%s/screenshot_%s.png'</span> % (path, filename)</div><div class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> tfile.endswith(<span class="string">'png'</span>):</div><div class="line">        destfile = <span class="string">"%s.png"</span> % destfile</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Save device screenshot to "</span>, destfile</div><div class="line">os.system(<span class="string">'adb %s shell screencap -p /sdcard/screen.png \</span></div><div class="line">    &amp;&amp; adb %s pull /sdcard/screen.png %s &amp;&amp; adb %s shell rm /sdcard/screen.png'</div><div class="line">          % (dev, dev, destfile, dev))</div></pre></td></tr></table></figure></div></article><div class="tags"><a href="/tags/Python/">Python</a><a href="/tags/Android/">Android</a></div><div class="paginator"><a href="/2015/04/07/mac-software-recommand/" class="prev"><i class="iconfont icon-left"></i><span> 上一页</span></a><a href="/2015/03/06/mac-svn-filter-by-name/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://ruikye.com/2015/03/14/adb-logcat-with-color/';
    this.page.identifier = '2015/03/14/adb-logcat-with-color/';
    this.page.title = 'ADB 的 Python 扩展';
};
(function() {
var d = document, s = d.createElement('script');

s.src = '//ruikye.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Ruikye</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>